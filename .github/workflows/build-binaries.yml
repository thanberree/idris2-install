name: Build Idris2 + pack binaries

on:
  workflow_dispatch:
    inputs:
      collection:
        description: 'Pack collection to use'
        required: true
        default: 'nightly-250828'
      build_ubuntu:
        description: 'Build Ubuntu'
        type: boolean
        default: true
      build_macos:
        description: 'Build macOS (PAYANT - consomme le quota)'
        type: boolean
        default: false

jobs:
  build-ubuntu:
    if: ${{ inputs.build_ubuntu }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev make gcc git

      - name: Install pack + Idris2
        run: |
          curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash -o install.bash
          # Patch for non-interactive install
          sed -i 's/read -r -p "Enter the name of your chez-scheme or racket binary \[\$DETECTED_SCHEME\]: " SCHEME/SCHEME=\${SCHEME:-\$DETECTED_SCHEME}/' install.bash
          bash install.bash
        env:
          SCHEME: chezscheme

      - name: Switch to target collection
        run: ~/.local/bin/pack --bootstrap switch ${{ github.event.inputs.collection }}

      - name: Install required packages
        run: |
          ~/.local/bin/pack install ansi containers contrib elab-pretty elab-util getopts hedgehog prettier-ansi pretty-show prim sop

      - name: Install idris2-lsp
        run: |
          ~/.local/bin/pack install-app idris2-lsp

      - name: Create standalone wrappers for idris2 and idris2-lsp
        run: |
          # Get commit hash and app hashes
          IDRIS2_COMMIT=$(ls ~/.local/state/pack/install/ | grep -E '^[0-9a-f]{40}$' | head -1)
          LSP_HASH=$(ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2-lsp/ | head -1)
          
          # Create standalone idris2 wrapper
          cat > ~/.local/bin/idris2 << WRAPPER
          #!/bin/sh
          set -e
          DIR=\$(dirname "\$(readlink -f -- "\$0")")
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2/bin/idris2"
          
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2 binary not found" >&2
            exit 2
          fi
          
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-0.7.0"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-0.7.0/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-0.7.0/support"
          
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2
          
          # Create standalone idris2-lsp wrapper
          cat > ~/.local/bin/idris2-lsp << WRAPPER
          #!/bin/sh
          set -e
          DIR=\$(dirname "\$(readlink -f -- "\$0")")
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp"
          
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2-lsp binary not found" >&2
            exit 2
          fi
          
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-0.7.0"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-0.7.0/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-0.7.0/support"
          export LD_LIBRARY_PATH="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp_app:\$LD_LIBRARY_PATH"
          
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2-lsp

      - name: Get OS codename
        id: os
        run: echo "codename=$(lsb_release -cs)" >> $GITHUB_OUTPUT

      - name: Create archive
        run: |
          cd ~
          tar --exclude='.git' -czvf idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz \
            .local/bin/pack \
            .local/bin/pack_app \
            .local/bin/idris2 \
            .local/bin/idris2-lsp \
            .local/state/pack \
            .config/pack \
            .cache/pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}
          path: ~/idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz

      - name: Upload to release
        run: |
          gh release upload v1.0 ~/idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-ubuntu:
    needs: build-ubuntu
    if: ${{ inputs.build_ubuntu }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Chez Scheme (runtime dependency)
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme

      - name: Get OS codename
        id: os
        run: echo "codename=$(lsb_release -cs)" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}
          path: ~/

      - name: Extract archive
        run: |
          cd ~
          tar xzf idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz

      - name: Test pack info
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pack info

      - name: Test idris2 --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2 --version

      - name: Test idris2-lsp --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2-lsp --version

      - name: Test compile Hello World
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-idris
          cat > /tmp/test-idris/Hello.idr << 'EOF'
          module Hello
          
          main : IO ()
          main = putStrLn "Hello from Idris2!"
          EOF
          cd /tmp/test-idris
          idris2 -o hello Hello.idr
          ./build/exec/hello

  build-macos:
    if: ${{ inputs.build_macos }}
    strategy:
      matrix:
        include:
          - os: macos-15-large
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Chez Scheme
        run: |
          brew install chezscheme
          # Create symlink so 'chezscheme' command exists
          sudo ln -sf $(brew --prefix)/bin/chez /usr/local/bin/chezscheme

      - name: Install pack + Idris2
        run: |
          curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash -o install.bash
          # Patch for non-interactive install (macOS sed syntax)
          sed -i '' 's/read -r -p "Enter the name of your chez-scheme or racket binary \[\$DETECTED_SCHEME\]: " SCHEME/SCHEME=\${SCHEME:-\$DETECTED_SCHEME}/' install.bash
          bash install.bash
        env:
          SCHEME: chez

      - name: Switch to target collection
        run: ~/.local/bin/pack --bootstrap switch ${{ github.event.inputs.collection }}

      - name: Install required packages
        run: |
          ~/.local/bin/pack install ansi containers contrib elab-pretty elab-util getopts hedgehog prettier-ansi pretty-show prim sop

      - name: Install idris2-lsp
        run: |
          ~/.local/bin/pack install-app idris2-lsp

      - name: Create standalone wrappers for idris2 and idris2-lsp
        run: |
          # Get commit hash and app hashes
          IDRIS2_COMMIT=$(ls ~/.local/state/pack/install/ | grep -E '^[0-9a-f]{40}$' | head -1)
          LSP_HASH=$(ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2-lsp/ | head -1)
          
          # Create standalone idris2 wrapper (macOS compatible)
          cat > ~/.local/bin/idris2 << WRAPPER
          #!/bin/sh
          set -e
          if [ "\$(uname)" = Darwin ]; then
            DIR=\$(cd "\$(dirname "\$0")" && pwd -P)
          else
            DIR=\$(dirname "\$(readlink -f -- "\$0")")
          fi
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2/bin/idris2"
          
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2 binary not found" >&2
            exit 2
          fi
          
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-0.7.0"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-0.7.0/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-0.7.0/support"
          
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2
          
          # Create standalone idris2-lsp wrapper (macOS compatible)
          cat > ~/.local/bin/idris2-lsp << WRAPPER
          #!/bin/sh
          set -e
          if [ "\$(uname)" = Darwin ]; then
            DIR=\$(cd "\$(dirname "\$0")" && pwd -P)
          else
            DIR=\$(dirname "\$(readlink -f -- "\$0")")
          fi
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp"
          
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2-lsp binary not found" >&2
            exit 2
          fi
          
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-0.7.0"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-0.7.0/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-0.7.0/support"
          export LD_LIBRARY_PATH="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp_app:\$LD_LIBRARY_PATH"
          export DYLD_LIBRARY_PATH="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp_app:\$DYLD_LIBRARY_PATH"
          
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2-lsp

      - name: Create archive
        run: |
          cd ~
          tar --exclude='.git' -czvf idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}-full.tar.gz \
            .local/bin/pack \
            .local/bin/pack_app \
            .local/bin/idris2 \
            .local/bin/idris2-lsp \
            .local/state/pack \
            .config/pack \
            .cache/pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}
          path: ~/idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}-full.tar.gz

      - name: Upload to release
        run: |
          gh release upload v1.0 ~/idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}-full.tar.gz --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-macos:
    needs: build-macos
    if: ${{ inputs.build_macos }}
    strategy:
      matrix:
        include:
          - os: macos-15-large
            arch: x86_64
          - os: macos-latest
            arch: arm64
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Chez Scheme (runtime dependency)
        run: brew install chezscheme

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}
          path: ~/

      - name: Extract archive
        run: |
          cd ~
          tar xzf idris2-pack-${{ github.event.inputs.collection }}-macos-${{ matrix.arch }}-full.tar.gz

      - name: Test pack info
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pack info

      - name: Test idris2 --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2 --version

      - name: Test idris2-lsp --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2-lsp --version

      - name: Test compile Hello World
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-idris
          cat > /tmp/test-idris/Hello.idr << 'EOF'
          module Hello
          
          main : IO ()
          main = putStrLn "Hello from Idris2!"
          EOF
          cd /tmp/test-idris
          idris2 -o hello Hello.idr
          ./build/exec/hello
