name: Build Idris2 + pack binaries

on:
  workflow_dispatch:
    inputs:
      collection:
        description: 'Pack collection to use'
        required: true
        default: 'nightly-250828'
      build_ubuntu:
        description: 'Build Ubuntu'
        type: boolean
        default: true
      macos_target:
        description: 'macOS target (none = skip macOS build)'
        type: choice
        options:
          - none
          - macos-14-arm64
          - macos-13-intel
        default: 'none'
      enable_ssh_debug:
        description: 'Enable SSH debug session after compilation'
        type: boolean
        default: false

# Required for gh release upload
permissions:
  contents: write

env:
  # Idris2 version embedded in paths - update when changing collection
  IDRIS2_VERSION: "0.7.0"

jobs:
  build-ubuntu:
    if: ${{ inputs.build_ubuntu }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme libgmp-dev make gcc git

      - name: Install pack + Idris2
        run: |
          curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash -o install.bash
          # Patch for non-interactive install
          sed -i 's/read -r -p "Enter the name of your chez-scheme or racket binary \[\$DETECTED_SCHEME\]: " SCHEME/SCHEME=\${SCHEME:-\$DETECTED_SCHEME}/' install.bash
          bash install.bash
        env:
          SCHEME: chezscheme

      - name: Switch to target collection
        run: ~/.local/bin/pack --bootstrap switch ${{ github.event.inputs.collection }}

      - name: Install required packages
        run: |
          ~/.local/bin/pack install ansi containers contrib elab-pretty elab-util getopts hedgehog prettier-ansi pretty-show prim sop

      - name: Install idris2-lsp
        run: |
          ~/.local/bin/pack install-app idris2-lsp

      - name: Create portable wrappers for idris2 and idris2-lsp
        run: |
          IDRIS2_VERSION="${{ env.IDRIS2_VERSION }}"
          
          echo "=== Creating portable wrappers ==="
          
          # Find idris2-lsp binary first
          LSP_BIN=$(find ~/.local/state/pack/install -name "idris2-lsp" -type f -executable 2>/dev/null | head -1)
          
          if [ -z "$LSP_BIN" ]; then
            echo "ERROR: Could not find idris2-lsp binary"
            exit 1
          fi
          
          echo "Found LSP binary: $LSP_BIN"
          
          # Extract COMMIT and HASH from path
          LSP_BIN_DIR=$(dirname "$LSP_BIN")
          LSP_HASH_DIR=$(dirname "$LSP_BIN_DIR")
          LSP_HASH=$(basename "$LSP_HASH_DIR")
          LSP_PARENT=$(dirname "$LSP_HASH_DIR")
          COMMIT_DIR=$(dirname "$LSP_PARENT")
          IDRIS2_COMMIT=$(basename "$COMMIT_DIR")
          
          echo "IDRIS2_COMMIT=$IDRIS2_COMMIT"
          echo "LSP_HASH=$LSP_HASH"
          
          # Verify paths
          ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2/bin/idris2
          ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2-lsp/$LSP_HASH/bin/idris2-lsp
          
          # Create idris2 wrapper
          cat > ~/.local/bin/idris2 << WRAPPER
          #!/bin/sh
          set -e
          DIR=\$(dirname "\$(readlink -f -- "\$0")")
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2/bin/idris2"
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2 binary not found" >&2
            exit 2
          fi
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/support"
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2
          
          # Create idris2-lsp wrapper
          cat > ~/.local/bin/idris2-lsp << WRAPPER
          #!/bin/sh
          set -e
          DIR=\$(dirname "\$(readlink -f -- "\$0")")
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp"
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2-lsp binary not found" >&2
            exit 2
          fi
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/support"
          export LD_LIBRARY_PATH="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp_app:\${LD_LIBRARY_PATH:-}"
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2-lsp
          
          echo "=== Wrappers created ==="

      - name: Get OS codename
        id: os
        run: echo "codename=$(lsb_release -cs)" >> $GITHUB_OUTPUT

      - name: Create archive
        run: |
          cd ~
          # Exclude .cache/pack/git (contains dirs without .git, breaks pack install-app)
          tar --exclude='.git' --exclude='.cache/pack/git' -czvf idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz \
            .local/bin/pack \
            .local/bin/pack_app \
            .local/bin/idris2 \
            .local/bin/idris2-lsp \
            .local/state/pack \
            .config/pack \
            .cache/pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}
          path: ~/idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz

      - name: Upload to release
        run: |
          gh release upload v1.0 ~/idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-ubuntu:
    needs: build-ubuntu
    if: ${{ inputs.build_ubuntu }}
    strategy:
      matrix:
        os: [ubuntu-22.04, ubuntu-24.04]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install Chez Scheme (runtime dependency)
        run: |
          sudo apt-get update
          sudo apt-get install -y chezscheme

      - name: Get OS codename
        id: os
        run: echo "codename=$(lsb_release -cs)" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}
          path: ~/

      - name: Extract archive
        run: |
          cd ~
          tar xzf idris2-pack-${{ github.event.inputs.collection }}-${{ steps.os.outputs.codename }}-full.tar.gz

      - name: Test pack info
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pack info

      - name: Test idris2 --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2 --version

      - name: Test idris2-lsp --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2-lsp --version

      - name: Test compile Hello World
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-idris
          cat > /tmp/test-idris/Hello.idr << 'EOF'
          module Hello
          
          main : IO ()
          main = putStrLn "Hello from Idris2!"
          EOF
          cd /tmp/test-idris
          idris2 -o hello Hello.idr
          ./build/exec/hello

      - name: Test pack with dependencies (real project)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-pack-project
          cd /tmp/test-pack-project
          
          # Create a pack.toml that uses pre-installed packages
          cat > pack.toml << 'EOF'
          [package]
          name = "test-project"
          version = "0.1.0"
          authors = ["Test"]
          brief = "Test project to verify installation"
          
          [dependencies]
          ansi = "^0.6.0"
          pretty-show = "^0.3.0"
          EOF
          
          # Create a source file that uses the dependencies
          mkdir -p src
          cat > src/Main.idr << 'EOF'
          module Main
          
          import Text.ANSI
          import Text.Show.Pretty
          
          record Person where
            constructor MkPerson
            name : String
            age : Nat
          
          Show Person where
            show (MkPerson n a) = "Person { name = " ++ show n ++ ", age = " ++ show a ++ " }"
          
          main : IO ()
          main = do
            let p = MkPerson "Alice" 30
            putStrLn $ colored BrightGreen "Testing pre-compiled packages:"
            putStrLn $ "  Person: " ++ show p
            putStrLn $ colored BrightBlue "✓ All dependencies work!"
          EOF
          
          # Build and run
          pack build test-project
          pack run test-project

  build-macos:
    if: ${{ inputs.macos_target != 'none' }}
    runs-on: ${{ inputs.macos_target == 'macos-14-arm64' && 'macos-14' || 'macos-13' }}
    env:
      MACOS_ARCH: ${{ inputs.macos_target == 'macos-14-arm64' && 'arm64' || 'x86_64' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show system info
        run: |
          echo "Runner: ${{ inputs.macos_target }}"
          echo "Architecture: $(uname -m)"
          echo "Expected: ${{ env.MACOS_ARCH }}"
          sw_vers

      - name: Install Chez Scheme via Homebrew
        run: |
          brew install chezscheme
          
          # Find where Homebrew installed chez
          BREW_PREFIX=$(brew --prefix)
          echo "Homebrew prefix: $BREW_PREFIX"
          
          # The binary is called 'chez' not 'chezscheme'
          if [ -x "$BREW_PREFIX/bin/chez" ]; then
            echo "Found: $BREW_PREFIX/bin/chez"
            # Create chezscheme symlink in a location that's in PATH
            sudo mkdir -p /usr/local/bin
            sudo ln -sf "$BREW_PREFIX/bin/chez" /usr/local/bin/chezscheme
            sudo ln -sf "$BREW_PREFIX/bin/chez" /usr/local/bin/chez
          elif [ -x "$BREW_PREFIX/bin/chezscheme" ]; then
            echo "Found: $BREW_PREFIX/bin/chezscheme"
            sudo mkdir -p /usr/local/bin
            sudo ln -sf "$BREW_PREFIX/bin/chezscheme" /usr/local/bin/chezscheme
          else
            echo "ERROR: Cannot find chez scheme binary"
            ls -la "$BREW_PREFIX/bin/" | grep -i chez || true
            exit 1
          fi
          
          # Verify
          echo "Verifying chezscheme installation:"
          which chezscheme || which chez
          chezscheme --version || chez --version

      - name: Install pack + Idris2
        run: |
          curl -fsSL https://raw.githubusercontent.com/stefan-hoeck/idris2-pack/main/install.bash -o install.bash
          
          # Patch for non-interactive install (macOS sed syntax - no backup extension)
          sed -i '' 's/read -r -p "Enter the name of your chez-scheme or racket binary \[\$DETECTED_SCHEME\]: " SCHEME/SCHEME=\${SCHEME:-\$DETECTED_SCHEME}/' install.bash
          
          # Use 'chez' as the scheme name (that's what Homebrew installs)
          SCHEME=chez bash install.bash
        env:
          SCHEME: chez

      - name: Switch to target collection
        run: ~/.local/bin/pack --bootstrap switch ${{ github.event.inputs.collection }}

      - name: Install required packages
        run: |
          ~/.local/bin/pack install ansi containers contrib elab-pretty elab-util getopts hedgehog prettier-ansi pretty-show prim sop

      - name: Install idris2-lsp
        run: |
          ~/.local/bin/pack install-app idris2-lsp

      - name: SSH debug session (if enabled)
        if: ${{ inputs.enable_ssh_debug }}
        uses: mxschmitt/action-tmate@v3
        timeout-minutes: 60

      - name: Create portable wrappers for idris2 and idris2-lsp
        run: |
          IDRIS2_VERSION="${{ env.IDRIS2_VERSION }}"
          
          echo "=== Creating portable wrappers ==="
          echo "IDRIS2_VERSION=$IDRIS2_VERSION"
          
          # Debug: Show all install directories
          echo "=== All install directories ==="
          ls -la ~/.local/state/pack/install/
          
          # Find idris2-lsp binary first - it tells us exactly where everything is
          LSP_BIN=$(find ~/.local/state/pack/install -name "idris2-lsp" -type f -perm +111 2>/dev/null | head -1)
          
          if [ -z "$LSP_BIN" ]; then
            echo "ERROR: Could not find idris2-lsp binary"
            find ~/.local/state/pack/install -name "idris2-lsp" 2>/dev/null || true
            exit 1
          fi
          
          echo "Found LSP binary: $LSP_BIN"
          
          # Path: ~/.local/state/pack/install/COMMIT/idris2-lsp/HASH/bin/idris2-lsp
          LSP_BIN_DIR=$(dirname "$LSP_BIN")           # .../HASH/bin
          LSP_HASH_DIR=$(dirname "$LSP_BIN_DIR")      # .../HASH
          LSP_HASH=$(basename "$LSP_HASH_DIR")        # HASH
          LSP_PARENT=$(dirname "$LSP_HASH_DIR")       # .../idris2-lsp
          COMMIT_DIR=$(dirname "$LSP_PARENT")         # .../COMMIT
          IDRIS2_COMMIT=$(basename "$COMMIT_DIR")     # COMMIT
          
          echo "IDRIS2_COMMIT=$IDRIS2_COMMIT"
          echo "LSP_HASH=$LSP_HASH"
          
          # Verify paths exist
          echo "Verifying paths..."
          ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2/bin/idris2
          ls ~/.local/state/pack/install/$IDRIS2_COMMIT/idris2-lsp/$LSP_HASH/bin/idris2-lsp
          
          # Create idris2 wrapper
          cat > ~/.local/bin/idris2 << WRAPPER
          #!/bin/sh
          set -e
          if [ "\$(uname)" = "Darwin" ]; then
            DIR=\$(cd "\$(dirname "\$0")" && pwd -P)
          else
            DIR=\$(dirname "\$(readlink -f -- "\$0")")
          fi
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2/bin/idris2"
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2 binary not found at \$APPLICATION" >&2
            exit 2
          fi
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/support"
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2
          
          # Create idris2-lsp wrapper
          cat > ~/.local/bin/idris2-lsp << WRAPPER
          #!/bin/sh
          set -e
          if [ "\$(uname)" = "Darwin" ]; then
            DIR=\$(cd "\$(dirname "\$0")" && pwd -P)
          else
            DIR=\$(dirname "\$(readlink -f -- "\$0")")
          fi
          INSTALL_DIR="\$DIR/../state/pack/install/$IDRIS2_COMMIT"
          APPLICATION="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp"
          if [ ! -x "\$APPLICATION" ]; then
            echo "[ fatal ] idris2-lsp binary not found at \$APPLICATION" >&2
            exit 2
          fi
          export IDRIS2_PREFIX="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION"
          export IDRIS2_PACKAGE_PATH="\$INSTALL_DIR"
          export IDRIS2_LIBS="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/lib"
          export IDRIS2_DATA="\$INSTALL_DIR/idris2/idris2-$IDRIS2_VERSION/support"
          LSP_APP_DIR="\$INSTALL_DIR/idris2-lsp/$LSP_HASH/bin/idris2-lsp_app"
          export DYLD_LIBRARY_PATH="\$LSP_APP_DIR:\${DYLD_LIBRARY_PATH:-}"
          exec "\$APPLICATION" "\$@"
          WRAPPER
          chmod +x ~/.local/bin/idris2-lsp
          
          echo "=== Wrappers created ==="
          head -5 ~/.local/bin/idris2
          head -5 ~/.local/bin/idris2-lsp

      - name: Create archive
        run: |
          cd ~
          # Exclude .cache/pack/git (contains dirs without .git, breaks pack install-app)
          tar --exclude='.git' --exclude='.cache/pack/git' -czvf idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}-full.tar.gz \
            .local/bin/pack \
            .local/bin/pack_app \
            .local/bin/idris2 \
            .local/bin/idris2-lsp \
            .local/state/pack \
            .config/pack \
            .cache/pack

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}
          path: ~/idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}-full.tar.gz

      - name: Upload to release
        run: |
          gh release upload v1.0 ~/idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}-full.tar.gz --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test-macos:
    needs: build-macos
    if: ${{ inputs.macos_target != 'none' }}
    runs-on: ${{ inputs.macos_target == 'macos-14-arm64' && 'macos-14' || 'macos-13' }}
    env:
      MACOS_ARCH: ${{ inputs.macos_target == 'macos-14-arm64' && 'arm64' || 'x86_64' }}
    steps:
      - name: Install Chez Scheme (runtime dependency)
        run: |
          brew install chezscheme
          
          # Create symlinks for the runtime
          BREW_PREFIX=$(brew --prefix)
          sudo mkdir -p /usr/local/bin
          if [ -x "$BREW_PREFIX/bin/chez" ]; then
            sudo ln -sf "$BREW_PREFIX/bin/chez" /usr/local/bin/chezscheme
            sudo ln -sf "$BREW_PREFIX/bin/chez" /usr/local/bin/chez
          elif [ -x "$BREW_PREFIX/bin/chezscheme" ]; then
            sudo ln -sf "$BREW_PREFIX/bin/chezscheme" /usr/local/bin/chezscheme
          fi

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}
          path: ~/

      - name: Extract archive
        run: |
          cd ~
          tar xzf idris2-pack-${{ github.event.inputs.collection }}-macos-${{ env.MACOS_ARCH }}-full.tar.gz

      - name: Test pack info
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          pack info

      - name: Test idris2 --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2 --version

      - name: Test idris2-lsp --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          idris2-lsp --version

      - name: Test compile Hello World
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-idris
          cat > /tmp/test-idris/Hello.idr << 'EOF'
          module Hello
          
          main : IO ()
          main = putStrLn "Hello from Idris2!"
          EOF
          cd /tmp/test-idris
          idris2 -o hello Hello.idr
          ./build/exec/hello

      - name: Test pack with dependencies (real project)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-pack-project
          cd /tmp/test-pack-project
          
          # Create a pack.toml that uses pre-installed packages
          cat > pack.toml << 'EOF'
          [package]
          name = "test-project"
          version = "0.1.0"
          authors = ["Test"]
          brief = "Test project to verify installation"
          
          [dependencies]
          ansi = "^0.6.0"
          pretty-show = "^0.3.0"
          EOF
          
          # Create a source file that uses the dependencies
          mkdir -p src
          cat > src/Main.idr << 'EOF'
          module Main
          
          import Text.ANSI
          import Text.Show.Pretty
          
          record Person where
            constructor MkPerson
            name : String
            age : Nat
          
          Show Person where
            show (MkPerson n a) = "Person { name = " ++ show n ++ ", age = " ++ show a ++ " }"
          
          main : IO ()
          main = do
            let p = MkPerson "Alice" 30
            putStrLn $ colored BrightGreen "Testing pre-compiled packages:"
            putStrLn $ "  Person: " ++ show p
            putStrLn $ colored BrightBlue "✓ All dependencies work!"
          EOF
          
          # Build and run
          pack build test-project
          pack run test-project
