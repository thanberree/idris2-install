name: Test existing binaries

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to test'
        type: choice
        options:
          - macos-14-arm64
          - ubuntu-24.04
          - ubuntu-22.04
        required: true
      collection:
        description: 'Collection name in archive'
        default: 'nightly-250828'
        required: true

jobs:
  test:
    runs-on: ${{ inputs.platform == 'macos-14-arm64' && 'macos-14' || inputs.platform }}
    steps:
      - name: Determine archive name
        id: archive
        run: |
          case "${{ inputs.platform }}" in
            macos-14-arm64) echo "name=idris2-pack-${{ inputs.collection }}-macos-arm64-full.tar.gz" >> $GITHUB_OUTPUT ;;
            ubuntu-24.04) echo "name=idris2-pack-${{ inputs.collection }}-noble-full.tar.gz" >> $GITHUB_OUTPUT ;;
            ubuntu-22.04) echo "name=idris2-pack-${{ inputs.collection }}-jammy-full.tar.gz" >> $GITHUB_OUTPUT ;;
          esac

      - name: Install Chez Scheme (runtime dependency)
        run: |
          if [[ "$(uname)" == "Darwin" ]]; then
            brew install chezscheme
            BREW_PREFIX=$(brew --prefix)
            sudo mkdir -p /usr/local/bin
            sudo ln -sf "$BREW_PREFIX/bin/chez" /usr/local/bin/chezscheme 2>/dev/null || true
            sudo ln -sf "$BREW_PREFIX/bin/chezscheme" /usr/local/bin/chezscheme 2>/dev/null || true
          else
            sudo apt-get update
            sudo apt-get install -y chezscheme
          fi

      - name: Download archive from release
        run: |
          echo "Downloading ${{ steps.archive.outputs.name }}..."
          curl -fsSL "https://github.com/thanberree/idris2-install/releases/download/v1.0/${{ steps.archive.outputs.name }}" -o /tmp/archive.tar.gz
          ls -lh /tmp/archive.tar.gz

      - name: Extract archive
        run: |
          cd ~
          tar xzf /tmp/archive.tar.gz
          echo "Extracted to $HOME"

      - name: Test pack info
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== pack info ==="
          pack info

      - name: Test idris2 --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== idris2 --version ==="
          idris2 --version

      - name: Test idris2-lsp --version
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "=== idris2-lsp --version ==="
          idris2-lsp --version

      - name: Test compile Hello World
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-idris
          cat > /tmp/test-idris/Hello.idr << 'EOF'
          module Hello
          
          main : IO ()
          main = putStrLn "Hello from Idris2!"
          EOF
          cd /tmp/test-idris
          echo "=== Compiling Hello.idr ==="
          idris2 -o hello Hello.idr
          echo "=== Running ==="
          ./build/exec/hello

      - name: Test pack with dependencies (real project)
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mkdir -p /tmp/test-pack-project
          cd /tmp/test-pack-project
          
          cat > pack.toml << 'EOF'
          [package]
          name = "test-project"
          version = "0.1.0"
          authors = ["Test"]
          brief = "Test project to verify installation"
          
          [dependencies]
          ansi = "^0.6.0"
          pretty-show = "^0.3.0"
          EOF
          
          mkdir -p src
          cat > src/Main.idr << 'EOF'
          module Main
          
          import Text.ANSI
          import Text.Show.Pretty
          
          record Person where
            constructor MkPerson
            name : String
            age : Nat
          
          Show Person where
            show (MkPerson n a) = "Person { name = " ++ show n ++ ", age = " ++ show a ++ " }"
          
          main : IO ()
          main = do
            let p = MkPerson "Alice" 30
            putStrLn $ colored BrightGreen "Testing pre-compiled packages:"
            putStrLn $ "  Person: " ++ show p
            putStrLn $ colored BrightBlue "All dependencies work!"
          EOF
          
          echo "=== pack build ==="
          pack build test-project
          echo "=== pack run ==="
          pack run test-project

      - name: Success summary
        run: |
          echo ""
          echo "=========================================="
          echo "  âœ… All tests passed for ${{ inputs.platform }}"
          echo "=========================================="
